
(function(){
  const root = document.documentElement;
  const body = document.body;
  const page = body.dataset.page || 'home';
  function setTheme(mode){ if(mode==='dark'){ root.classList.add('dark'); } else { root.classList.remove('dark'); } localStorage.setItem('theme', mode);} const savedTheme = localStorage.getItem('theme') || 'light'; setTheme(savedTheme);
  const themeBtn = document.querySelector('#themeToggle'); if(themeBtn){ themeBtn.addEventListener('click', ()=>{ const next = root.classList.contains('dark') ? 'light' : 'dark'; setTheme(next); themeBtn.textContent = next==='dark' ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark'; }); themeBtn.textContent = savedTheme==='dark' ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark'; }
  const searchInput = document.querySelector('#globalSearch'); if(searchInput){ searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const q = encodeURIComponent(searchInput.value.trim()); if(q) window.location.href = `search.html?q=${q}`; } }); }
  const store = { get: (key, def=[]) => { try{ const v = JSON.parse(localStorage.getItem(key)); return Array.isArray(v) ? v : def; }catch(_){ return def; } }, set: (key, value) => localStorage.setItem(key, JSON.stringify(value)), clear: (key) => localStorage.removeItem(key) };
  const anns = store.get('announcements'); if(!anns.length){ store.set('announcements', DEFAULT_ANNOUNCEMENTS); }

  const controllers = {
    home(){ const ql = document.querySelector('#quickLinks'); if(ql){ ql.innerHTML = QUICK_LINKS.map(l=>`<a class="btn" href="${l.href}">â¡ï¸ ${l.label}</a>`).join(' ');} const list = document.querySelector('#homeAnnouncements'); const items = store.get('announcements'); if(list){ list.innerHTML = items.map(a=>`<div class='ann-item'><h4>${a.title}</h4><div class='meta'>${a.date}</div><div>${a.body}</div></div>`).join(''); } const reqs = store.get('requests'); const total = reqs.length; const pending = reqs.filter(r=>r.status==='Pending').length; const completed = reqs.filter(r=>r.status==='Completed').length; const elTotal = document.querySelector('#kpiTotal'); const elPending = document.querySelector('#kpiPending'); const elCompleted = document.querySelector('#kpiCompleted'); if(elTotal) elTotal.textContent = total; if(elPending) elPending.textContent = pending; if(elCompleted) elCompleted.textContent = completed; },

    requests(){ const form = document.querySelector('#requestForm'); const tableBody = document.querySelector('#requestsTableBody'); const exportBtn = document.querySelector('#exportCsv'); function render(){ const reqs = store.get('requests'); tableBody.innerHTML = reqs.map((r,i)=>{ return `<tr> <td>${r.ref}</td> <td>${r.type}</td> <td>${r.studentId}</td> <td>${r.name}</td> <td>${r.program}</td> <td>${r.email}</td> <td>${r.purpose||''}</td> <td>${r.date}</td> <td><span class='badge'>${r.status}</span></td> <td class='actions'> <button class='btn' data-action='complete' data-i='${i}'>âœ…</button> <button class='btn danger' data-action='delete' data-i='${i}'>ğŸ—‘ï¸</button> </td> </tr>` }).join(''); }
      function randomRef(){ return 'REQ-' + Math.random().toString(36).substring(2,8).toUpperCase(); }
      form.addEventListener('submit', (e)=>{ e.preventDefault(); const data = Object.fromEntries(new FormData(form).entries()); const reqs = store.get('requests'); reqs.unshift({ ref: randomRef(), type: data.type, studentId: data.studentId, name: data.name, program: data.program, email: data.email, purpose: data.purpose, date: new Date().toISOString().slice(0,10), status: 'Pending' }); store.set('requests', reqs);
        // Optional: send email notification via Power Automate webhook
        if(window.NOTIFY_WEBHOOK_URL){ try{ fetch(window.NOTIFY_WEBHOOK_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ type: data.type, studentId: data.studentId, name: data.name, program: data.program, email: data.email, purpose: data.purpose, ref: reqs[0].ref, date: reqs[0].date }) }); }catch(err){ console.warn('Notify webhook failed', err); } }
        form.reset(); render(); });
      document.querySelector('#requestsTable').addEventListener('click', (e)=>{ const btn = e.target.closest('button'); if(!btn) return; const i = parseInt(btn.dataset.i,10); const reqs = store.get('requests'); const action = btn.dataset.action; if(action==='complete'){ reqs[i].status='Completed'; } if(action==='delete'){ reqs.splice(i,1); } store.set('requests', reqs); render(); }); exportBtn.addEventListener('click', ()=>{ const reqs = store.get('requests'); const headers = ['Ref','Type','Student ID','Name','Program','Email','Purpose','Date','Status']; const csv = [headers.join(',')].concat(reqs.map(r=>[ r.ref, r.type, r.studentId, r.name, r.program, r.email, (r.purpose||'').replace(/,/g,';'), r.date, r.status ].join(','))).join('\n'); const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'requests.csv'; a.click(); }); render(); },

    records(){ const tbody = document.querySelector('#recordsBody'); const query = document.querySelector('#recordQuery'); const statusFilter = document.querySelector('#statusFilter'); const programFilter = document.querySelector('#programFilter'); function render(){ const q = (query.value||'').toLowerCase(); const status = statusFilter.value; const program = programFilter.value; const filtered = STUDENTS.filter(s=>{ const matchQ = !q || s.name.toLowerCase().includes(q) || s.id.toLowerCase().includes(q) || s.program.toLowerCase().includes(q); const matchStatus = !status || s.status===status; const matchProgram = !program || s.program===program; return matchQ && matchStatus && matchProgram; }); tbody.innerHTML = filtered.map(s=>`<tr> <td>${s.id}</td> <td>${s.name}</td> <td>${s.program}</td> <td>Year ${s.year}</td> <td>${s.status}</td> <td><button class='btn'>ğŸ–¨ï¸ Print</button></td> </tr>`).join(''); document.querySelector('#recordCount').textContent = filtered.length; } [query, statusFilter, programFilter].forEach(el=> el.addEventListener('input', render)); const programs = [...new Set(STUDENTS.map(s=>s.program))]; programFilter.innerHTML = `<option value=''>All</option>` + programs.map(p=>`<option>${p}</option>`).join(''); render(); },

    forms(){},

    reports(){ const container = document.querySelector('#chart'); const reqs = store.get('requests'); const byType = {}; for(const r of reqs){ byType[r.type] = (byType[r.type]||0)+1; } const entries = Object.entries(byType); if(!entries.length){ container.innerHTML = '<div class="meta">No data yet. Submit a few requests to populate this chart.</div>'; return; } const max = Math.max(...entries.map(([_,v])=>v)); container.innerHTML = entries.map(([type,count])=>{ const pct = Math.round((count/max)*100); return `<div style='margin:8px 0'><div class='meta' style='margin-bottom:4px'>${type} â€” ${count}</div><div style='background:var(--bg); border:1px solid var(--border); border-radius:8px; overflow:hidden'><div style='width:${pct}%; background:var(--primary); color:#fff; padding:6px 8px'>${pct}%</div></div></div>`; }).join(''); },

    announcements(){ const list = document.querySelector('#annList'); const form = document.querySelector('#annForm'); function render(){ const items = store.get('announcements'); list.innerHTML = items.map((a,i)=>`<div class='ann-item'><h4>${a.title}</h4><div class='meta'>${a.date}</div><div>${a.body}</div><div style='margin-top:8px'><button class='btn danger' data-i='${i}'>Delete</button></div></div>`).join(''); } form.addEventListener('submit', (e)=>{ e.preventDefault(); const data = Object.fromEntries(new FormData(form).entries()); const items = store.get('announcements'); items.unshift({title:data.title, body:data.body, date:data.date||new Date().toISOString().slice(0,10)}); store.set('announcements', items); form.reset(); render(); }); list.addEventListener('click', (e)=>{ const i = e.target.dataset.i; if(i!==undefined){ const items = store.get('announcements'); items.splice(parseInt(i,10),1); store.set('announcements', items); render(); } }); render(); },

    faq(){}, contact(){}, admin(){ document.querySelector('#resetStorage').addEventListener('click', ()=>{ if(confirm('Reset local storage data?')){ localStorage.clear(); alert('Local data cleared.'); window.location.reload(); } }); },

    search(){ const params = new URLSearchParams(window.location.search); const q = (params.get('q')||'').toLowerCase(); const out = document.querySelector('#searchResults'); const ann = store.get('announcements').filter(a=> a.title.toLowerCase().includes(q) || a.body.toLowerCase().includes(q)); const students = STUDENTS.filter(s=> s.name.toLowerCase().includes(q) || s.id.toLowerCase().includes(q) || s.program.toLowerCase().includes(q)); const reqs = store.get('requests').filter(r=> r.ref.toLowerCase().includes(q) || r.name.toLowerCase().includes(q)); out.innerHTML = `<div class='card'><h3>Announcements (${ann.length})</h3>${ann.map(a=>`<div class='ann-item'><strong>${a.title}</strong><div class='meta'>${a.date}</div><div>${a.body}</div></div>`).join('') || '<div class="meta">No matches</div>'}</div><div class='card'><h3>Students (${students.length})</h3>${students.map(s=>`<div>${s.id} â€” ${s.name} â€” ${s.program}</div>`).join('') || '<div class="meta">No matches</div>'}</div><div class='card'><h3>Requests (${reqs.length})</h3>${reqs.map(r=>`<div>${r.ref} â€” ${r.name} â€” ${r.type} â€” ${r.status}</div>`).join('') || '<div class="meta">No matches</div>'}</div>`; document.querySelector('#queryEcho').textContent = params.get('q')||''; },

    calendar(){ const form = document.querySelector('#deadlineForm'); const list = document.querySelector('#deadlineList'); const exportAll = document.querySelector('#exportIcs'); const local = { get:()=>{ try{const v=JSON.parse(localStorage.getItem('deadlines')); return Array.isArray(v)?v:[];}catch(_){return [];} }, set:(v)=> localStorage.setItem('deadlines', JSON.stringify(v)) }; function render(){ const items = local.get(); list.innerHTML = items.map((d,i)=>`<div class='ann-item'><h4>${d.title}</h4><div class='meta'>Due: ${d.due} â€¢ Category: ${d.category||'â€”'}</div><div style='margin-top:8px; display:flex; gap:8px'><button class='btn' data-action='ics' data-i='${i}'>ğŸ“† Export .ics</button><button class='btn danger' data-action='del' data-i='${i}'>ğŸ—‘ï¸ Delete</button></div></div>`).join(''); } function buildIcs(evt){ const pad = (n)=> ('0'+n).slice(-2); const dtstamp = new Date(); const DS = `${dtstamp.getUTCFullYear()}${pad(dtstamp.getUTCMonth()+1)}${pad(dtstamp.getUTCDate())}T${pad(dtstamp.getUTCHours())}${pad(dtstamp.getUTCMinutes())}${pad(dtstamp.getUTCSeconds())}Z`; const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Registrar Hub//Deadlines//EN','CALSCALE:GREGORIAN']; function addEvent(d){ const uid = 'DL-' + Math.random().toString(36).substring(2,10).toUpperCase(); const start = new Date(d.due + 'T09:00:00'); const end = new Date(d.due + 'T10:00:00'); function fmt(date){ return date.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'; } lines.push('BEGIN:VEVENT'); lines.push('UID:' + uid); lines.push('DTSTAMP:' + DS); lines.push('DTSTART:' + fmt(start)); lines.push('DTEND:' + fmt(end)); lines.push('SUMMARY:' + (d.title||'Deadline')); if(d.category) lines.push('CATEGORIES:' + d.category); lines.push('END:VEVENT'); } if(evt){ addEvent(evt); } else { const items = local.get(); items.forEach(addEvent); } lines.push('END:VCALENDAR'); const blob = new Blob([lines.join('\n')], {type:'text/calendar'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = evt ? 'deadline.ics' : 'deadlines.ics'; a.click(); } form.addEventListener('submit', (e)=>{ e.preventDefault(); const data = Object.fromEntries(new FormData(form).entries()); const items = local.get(); items.unshift({title:data.title, due:data.due, category:data.category}); local.set(items); form.reset(); render(); }); list.addEventListener('click', (e)=>{ const btn = e.target.closest('button'); if(!btn) return; const i = parseInt(btn.dataset.i,10); const items = local.get(); const action = btn.dataset.action; if(action==='del'){ items.splice(i,1); local.set(items); render(); } if(action==='ics'){ buildIcs(items[i]); } }); exportAll.addEventListener('click', ()=> buildIcs(null)); render(); },
  };
  if(controllers[page]) controllers[page]();
})();
